# 规范增量：多 Git 仓库发现与选择

## ADDED Requirements

### Requirement: Git 仓库发现与列表

系统 SHALL 自动扫描项目内所有 Git 仓库并提供列表供用户选择。

#### Scenario: 扫描项目内所有 Git 仓库

- **WHEN** 用户打开 Git 代码统计工具
- **THEN** 系统应在后台自动扫描项目目录树，识别所有包含 `.git` 目录的仓库
- **AND** 应返回相对于项目根目录的仓库列表
- **AND** 扫描应在后台线程执行，不阻塞 UI

#### Scenario: 处理嵌套 Git 仓库

- **WHEN** 项目包含子模块或嵌套仓库（如 `project/submodule/.git`, `project/libs/lib1/.git`）
- **THEN** 系统应正确识别并列出所有仓库
- **AND** 应记录相对于项目根目录的路径

#### Scenario: 排除不必要的目录

- **WHEN** 扫描项目目录时
- **THEN** 系统应跳过以下常见依赖和构建目录：
  - `node_modules`, `bower_components` (JavaScript)
  - `target`, `build`, `dist` (编译输出)
  - `.gradle`, `.maven`, `.m2` (构建系统)
  - `venv`, `.venv`, `env` (Python)
  - `.idea`, `.vscode`, `.DS_Store` (IDE 和系统文件)
- **AND** 应避免进入这些目录进行递归扫描

#### Scenario: 扫描深度限制

- **WHEN** 进行仓库扫描时
- **THEN** 系统应限制最大扫描深度为 3 层（可配置）
- **AND** 防止过深扫描导致性能下降

#### Scenario: 无有效 Git 仓库的处理

- **WHEN** 扫描结果为空（项目非 Git 仓库或无子仓库）
- **THEN** 系统应显示提示信息 "未发现 Git 仓库"
- **AND** 应禁用分支、作者、统计相关控件
- **AND** 保留仓库选择框为空

#### Scenario: 扫描性能

- **WHEN** 用户首次打开工具或点击刷新按钮
- **THEN** 扫描应在 500ms 内完成（对于中等规模项目）
- **AND** 使用后台线程以避免 UI 冻结

### Requirement: 仓库选择交互

系统 SHALL 在 UI 中提供仓库选择下拉框，允许用户在多个仓库间切换。

#### Scenario: 仓库选择框的显示

- **WHEN** 用户打开 Git 代码统计工具
- **THEN** 系统应在分支选择框上方显示一个"仓库"下拉框
- **AND** 下拉框应列出所有扫描到的 Git 仓库

#### Scenario: 仓库项目显示

- **WHEN** 用户展开仓库下拉框
- **THEN** 系统应显示：
  - 主仓库：标记为 "主仓库" 或显示 "(主)" 标签
  - 其他仓库：显示相对于项目根目录的路径或仓库名称
  - 每项应清晰易区分

#### Scenario: 默认仓库选择

- **WHEN** 工具初始化完成
- **THEN** 系统应自动选择项目根目录的主仓库作为默认选项
- **AND** 若无主仓库，则选择列表中的第一个仓库

#### Scenario: 仓库切换

- **WHEN** 用户在下拉框中选择不同的仓库
- **THEN** 系统应：
  1. 切换 `GitCommandExecutor` 的工作目录到新选择的仓库
  2. 重新加载该仓库的分支列表
  3. 重新加载该仓库的作者列表
  4. 清空统计结果表格
  5. 更新状态标签提示 "已切换至仓库：[仓库名]"

#### Scenario: 仓库切换失败处理

- **WHEN** 切换到新仓库时发生错误（如权限不足、不是有效仓库）
- **THEN** 系统应：
  1. 显示错误提示 "无法切换仓库：[错误原因]"
  2. 保留当前仓库的选择和数据不变
  3. 不清空统计结果

### Requirement: 分支默认选择优化

系统 SHALL 在加载分支列表时，默认展示仓库的当前 HEAD 分支。

#### Scenario: 获取当前 HEAD 分支

- **WHEN** 加载仓库的分支列表时
- **THEN** 系统应执行 `git symbolic-ref --short HEAD` 或 `git rev-parse --abbrev-ref HEAD` 获取当前分支
- **AND** 获取失败时（如 detached HEAD），使用列表中的第一个分支作为备选

#### Scenario: 默认分支选中

- **WHEN** 分支列表加载完成
- **THEN** 系统应自动将当前 HEAD 分支设为下拉框的默认选项
- **AND** 用户界面应清晰显示当前分支已被选中

#### Scenario: 分支列表刷新

- **WHEN** 用户切换仓库或点击刷新按钮
- **THEN** 分支列表应重新加载，并再次应用默认 HEAD 分支选择
- **AND** 以前的分支选择应被覆盖

### Requirement: 数据一致性

系统 SHALL 确保在多仓库环境中数据的一致性和正确性。

#### Scenario: 统计数据仓库绑定

- **WHEN** 用户在仓库 A 中进行统计，然后切换到仓库 B
- **THEN** 之前的统计结果应被清空（不混淆不同仓库的数据）
- **AND** 新仓库的分支、作者、时间范围都应重新初始化

#### Scenario: 后台操作期间的仓库切换

- **WHEN** 统计操作进行中，用户切换仓库
- **THEN** 系统应：
  1. 停止或取消当前统计操作
  2. 显示提示 "统计已取消"
  3. 允许切换到新仓库

#### Scenario: 仓库文件系统变化

- **WHEN** 扫描完成后，项目目录结构发生变化（如添加/删除子模块）
- **THEN** 用户应通过点击"刷新"按钮重新扫描仓库列表
- **AND** 系统应更新仓库选择框

### Requirement: 错误处理与恢复

系统 SHALL 妥善处理各种异常情况，提供清晰的错误提示和恢复机制。

#### Scenario: 不可访问的目录

- **WHEN** 扫描过程中遇到权限不足的目录
- **THEN** 系统应跳过该目录，继续扫描其他目录
- **AND** 可记录日志但不向用户显示每个细节

#### Scenario: 工作目录不存在

- **WHEN** 切换到的仓库目录已被删除或移动
- **THEN** 系统应检测到错误并显示提示 "仓库目录不存在"
- **AND** 自动从下拉框中移除该仓库
- **AND** 恢复到上一个有效的仓库

#### Scenario: Git 命令在新工作目录失败

- **WHEN** 在新仓库中执行 Git 命令时失败
- **THEN** 系统应显示错误信息，如 "Git 命令执行失败：[错误详情]"
- **AND** 不影响其他仓库的操作

